<!--
===========================================================================
  YouTube Channel Widget for Notion ─ v3.5 (stable, Notion-safe)
  -------------------------------------------------------------------------
  • Banner + channel bar with Subscribe / Share
  • 3‑LINE CLAMPED “About” preview + expandable full text
  • Inline player + close button
  • Video list with Open / Comments / Share
  • Search, dark‑mode, lazy‑load thumbnails, fluid layout
  • NO external libraries (just fetch)
  • API key & channel overridable via URL hash/query
===========================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Widget</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Scoped Reset - Only affects elements in this widget */
    .yt-feed-widget *,
    .yt-feed-widget *::before,
    .yt-feed-widget *::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      /* YouTube Light mode colors */
      --c-text:#0f0f0f; 
      --c-muted:#606060; 
      --c-line:#e5e5e5; 
      --c-bg:#ffffff;
      --c-bg-secondary:#f9f9f9;
      --c-accent:#ff0000; /* YouTube Red */
      --c-accent-hover:#cc0000;
      --c-accent-light:rgba(255, 0, 0, 0.1);
      --c-accent-gradient:linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
      --c-shadow:rgba(0,0,0,.1); 
      --c-thumb-shadow:rgba(0,0,0,.2);
      --radius:.25rem; /* YouTube uses very subtle rounding */
      --radius-lg:.5rem;
      --radius-full:9999px;
      --thumb-w:180px;
      --transition:all 0.15s ease; 
      --card-shadow:0 1px 3px var(--c-shadow);
      --card-shadow-hover:0 2px 8px var(--c-shadow);
      --font-primary:'Roboto', 'YouTube Sans', Arial, sans-serif; /* YouTube uses Roboto/YouTube Sans */
      --font-weight-normal:400; 
      --font-weight-medium:500;
      --font-weight-bold:600;
      
      /* Hover states */
      --hover-bg:#f2f2f2;
      --hover-dark-bg:#272727;
      
      /* UI elements */
      --glass-bg:#ffffff;
      --glass-border:var(--c-line);
      --glass-shadow:0 2px 4px rgba(0, 0, 0, 0.05);
      --glass-blur:0px; /* YouTube doesn't use glass effects */
      
      /* Skeleton colors - light mode */
      --skeleton-base:#f0f0f0;
      --skeleton-highlight:rgba(255,255,255,0.8);
      
      /* Light mode specific */
      --scrollbar-thumb:#c7c7c7;
      --scrollbar-track:#f1f1f1;
    }
    
    @media (prefers-color-scheme:dark){
      :root{ 
        /* YouTube Dark mode colors */
        --c-text:#ffffff; 
        --c-muted:#aaaaaa; 
        --c-line:#303030; 
        --c-bg:#0f0f0f;
        --c-bg-secondary:#181818;
        --c-accent:#ff0000; /* YouTube Red */
        --c-accent-hover:#ff4444; 
        --c-accent-light:rgba(255, 0, 0, 0.2);
        --c-accent-gradient:linear-gradient(135deg, #ff4444 0%, #ff0000 100%);
        --c-shadow:rgba(0,0,0,.4);
        --c-thumb-shadow:rgba(0,0,0,.5);
        
        /* UI elements - dark mode */
        --glass-bg:#212121;
        --glass-border:#303030;
        --glass-shadow:0 2px 4px rgba(0, 0, 0, 0.2);
        --hover-bg:#272727;
        
        /* Skeleton colors - dark mode */
        --skeleton-base:#272727;
        --skeleton-highlight:rgba(60, 60, 60, 0.8);
        
        /* Dark mode specific */
        --scrollbar-thumb:#606060;
        --scrollbar-track:#181818;
      }
    }
    
    /* Accessibility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    
    /* Custom scrollbar - Scoped to widget only */
    .yt-feed-widget ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .yt-feed-widget ::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }
    
    .yt-feed-widget ::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }
    
    .yt-feed-widget ::-webkit-scrollbar-thumb:hover {
      background: var(--c-accent);
    }
    /* When used as full page */
    body.yt-feed-body{
      font-family:var(--font-primary);
      background:linear-gradient(135deg, var(--c-bg) 0%, var(--c-bg-secondary) 100%);
      color:var(--c-text);
      line-height:1.5;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2rem;
      overflow-x:hidden;
    }
    
    /* Widget container styling regardless of embedding */
    .yt-feed-widget {
      font-family:var(--font-primary);
      color:var(--c-text);
      line-height:1.5;
      width:100%;
      height:100%;
      overflow: hidden; /* Prevent any overflow outside the widget container */
      display: flex;
      flex-direction: column;
    }
    a{
      color:inherit;
      text-decoration:none;
      transition:var(--transition);
      position:relative;
    }
    button{
      cursor:pointer;
      background:none;
      border:0;
      color:inherit;
      transition:var(--transition);
      font-family:var(--font-primary);
    }
    
    /* Selection styling - Scoped to widget */
    .yt-feed-widget ::selection {
      background:var(--c-accent-light);
      color:var(--c-accent);
    }

    /* Shell - YouTube style */
    #widget{
      display: flex;
      flex-direction: column;
      width: 100%; /* Always take full width of container */
      max-width: 1280px; /* YouTube's exact width */
      height: 100%;
      border: none;
      border-radius: 0;
      overflow: hidden;
      box-shadow: none;
      background: var(--c-bg);
      margin: 0 auto; /* Center if smaller than container */
    }
    
    /* Notification popup styling */
    .notification-popup {
      background: var(--c-bg);
      border: 1px solid var(--c-line);
      border-radius: var(--radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      animation: fadeIn 0.35s ease;
      width: 200px;
      position: absolute;
      top: 45px; /* Position below the button */
      right: 10px;
    }
    
    .notification-options {
      padding: 8px 0;
    }
    
    .notification-option {
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .notification-option:hover {
      background: var(--hover-bg);
    }
    
    /* Toast notification */
    .toast-notification {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 2000; /* Higher z-index to be above all elements */
    }

    /* YouTube-style channel header */
    .banner{
      height: 88px; /* YouTube's exact banner height */
      min-height: 88px;
      background-size: cover; /* default */
      background-position: center;
      position: relative;
      overflow: hidden;
    }
    /* Ensure proper aspect ratio for banner background where possible */
    @media (min-width: 640px){
      .banner{ background-size: cover; }
    }
    
    .banner::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.05); /* YouTube's subtle overlay */
      z-index: 1;
    }
    
    .banner-content {
      display: none; /* YouTube doesn't show text on the banner */
    }
    
    /* Channel bar - YouTube style */
    .channel-bar{
      position: relative;
      z-index: 2;
      margin-top: -24px; /* Overlap a bit less so the logo sits lower */
      padding: 0 16px 0 136px; /* Space for avatar - YouTube's exact spacing */
      height: 116px; /* YouTube's exact height */
      display: flex;
      align-items: flex-end;
      background: transparent;
      border-bottom: none;
    }
    
    .channel-thumb{
      position: absolute;
      left: 24px; /* YouTube's exact spacing */
      top: -20px; /* Move logo down from cover */
      width: 80px; /* YouTube's exact size */
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      background: var(--c-bg);
    }
    
    /* YouTube-style header info layout */
    .banner-header-info {
      padding: 16px 0 24px; /* YouTube's exact padding */
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .channel-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .channel-header-text {
      display: flex;
      flex-direction: column;
    }

    /* YouTube style subscribe button row */
    .channel-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    /* Already defined above with YouTube style positioning */
    /* YouTube-style buttons */
    .actions {
      display: flex;
      gap: 8px; /* YouTube's exact spacing */
    }
    .btn {
      font-size: 14px; /* YouTube's exact font size */
      padding: 0 16px; /* YouTube's exact padding */
      border-radius: 18px; /* YouTube now uses rounded buttons */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px; /* YouTube's exact spacing */
      font-weight: 500;
      transition: var(--transition);
      text-transform: uppercase; /* YouTube buttons are uppercase */
      letter-spacing: 0.007px; /* YouTube's exact letter spacing */
      min-width: 0;
      height: 36px;
    }
    .btn-primary {
      background: var(--c-bg);
      color: var(--c-text);
      border: 1px solid var(--c-line); /* YouTube now uses outlined buttons */
      box-shadow: none;
    }
    .btn-primary:hover {
      background: rgba(0,0,0,0.05);
      transform: none;
      box-shadow: none;
    }
    .btn-primary:focus {
      outline: none;
      background: rgba(0,0,0,0.1);
    }
    /* Subscribe button is special - it's filled */
    #subBtn {
      background: var(--c-text);
      color: rgb(0, 0, 0);
      border: none;
      padding: 0 16px;
    }
    #subBtn:hover {
      background: #272727;
      color: white;
    }
    .btn-secondary {
      width: 36px;
      min-width: 36px;
      padding: 0;
      border: none;
      background: transparent;
      color: var(--c-text);
    }
    .btn-secondary:hover {
      background: rgba(0,0,0,0.05);
      color: var(--c-text);
      transform: none;
    }
    .btn-secondary.active {
      color: var(--c-accent);
    }
    .btn-secondary svg {
      width: 24px;
      height: 24px;
    }

    /* About section - YouTube style */
    #aboutWrap{
      border-bottom: 1px solid var(--c-line);
      background: var(--c-bg);
      transition: var(--transition);
      padding: 0 16px;
    }
    #aboutToggle{
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      font-size: 0.85rem;
      padding: 0.75rem 0;
      color: var(--c-text);
      font-weight: var(--font-weight-medium);
      border-bottom: 1px solid var(--c-line);
      margin-bottom: 0.75rem;
    }
    #aboutToggle:hover{
      color: var(--c-accent);
    }
    #aboutToggle .toggle-text{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
    }
    #aboutArrow{
      transition: transform 0.45s ease;
      opacity: 0.7;
      font-size: 0.75rem;
      height: 20px;
      width: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #aboutToggle:hover #aboutArrow{
      opacity: 1;
    }
    #aboutPreview{
      padding: 0.5rem 0 1rem 0;
      font-size: 0.875rem;
      color: var(--c-muted);
      line-height: 1.5;
    }
    .about-full{
      padding: 0.5rem 0 1rem 0;
      font-size: 0.875rem;
      color: var(--c-muted);
      line-height: 1.5;
      animation: fadeIn 0.45s ease;
    }
    .about-full p{
      margin-bottom: 0.75rem;
    }
    /* Use line clamp so preview is exactly 2 lines like YouTube */
    .clamp-3{
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2; /* standard property for compatibility */
      overflow: hidden;
      line-height: 1.5;
      max-height: 3em;
    }
    /* Full text starts hidden; we toggle via inline display styles */
    .about-full{display:none}
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Search - YouTube style */
    .search{
      padding: 0 16px 12px;
      margin-top: 12px; /* Space below description */
      border-bottom: none;
      background: var(--c-bg);
      position: relative;
     
    }
    .search-input{
      width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 1rem; /* Search icon on right like YouTube */
      border: 1px solid var(--c-line);
      border-radius: 2px; /* YouTube search has minimal border radius */
      font-size: 0.875rem;
      background: var(--c-bg);
      color: inherit;
      transition: var(--transition);
      align-items: center;
      justify-content: center;
    }
    .search-input:focus{
      outline: none;
      border-color: #1c62b9; /* YouTube's focused input color */
      box-shadow: 0 0 0 1px #1c62b9;
    }
    .search-input::placeholder{
      color: var(--c-muted);
      opacity: 0.7;
    }
    /* Replace pseudo-element with a real, clickable button for accessibility */
    .search-btn{
      position:absolute;
      right: 10px;  
      top: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--c-muted);
      cursor: pointer;
    }
    .search-btn:hover{ color: var(--c-text); }

    /* Player - YouTube style */
    #playerWrap {
      position: relative;
      padding-top: 56.25%; /* 16:9 aspect ratio */
      display: none;
      border-bottom: none;
      box-shadow: none; /* YouTube player doesn't have shadows */
      animation: fadeIn 0.3s ease;
    }
    #player {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }
    /* YouTube style close button (X in corner) */
    #closePlayer {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,.6);
      color: white;
      border-radius: 2px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: var(--transition);
      opacity: 0;
      z-index: 10;
    }
    #playerWrap:hover #closePlayer {
      opacity: 1;
    }
    #closePlayer:hover {
      background: rgba(0,0,0,.8);
      transform: none;
    }
    #playerLoading {
      transition: opacity 0.3s ease;
    }

    /* Videos - YouTube style */
    #videos{
      flex:1;
      overflow-y:auto; /* Vertical scrolling */
      overflow-x:hidden; /* No horizontal scrolling */
      padding:24px 16px; /* YouTube's exact padding */
      background:var(--c-bg);
      position:relative;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    .videos-container {
      display: flex;
      flex-direction: column;
      gap: 16px; /* YouTube's exact spacing */
      max-width: 862px; /* YouTube's exact width */
      margin: 0 auto;
    }
    .video{
      display:flex;
      gap:16px; /* YouTube's exact spacing */
      padding:0;
      border-radius:0;
      transition:var(--transition);
      position:relative;
      background:transparent;
      border:none;
      box-shadow:none;
    }
    .video:hover{
      background:transparent; /* YouTube doesn't change background on hover */
      transform:none;
      box-shadow:none;
      border-color:transparent;
    }
    .thumb-container{
      position:relative;
      overflow:hidden;
      border-radius:8px; /* YouTube's exact border radius */
      box-shadow:none;
      transition:var(--transition);
      width:360px; /* YouTube's exact width */
      height:auto; /* let image set height via aspect ratio */
      aspect-ratio:16/9;
      flex-shrink: 0;
    }
    .thumb{
      width:100%;
      height:100%;
      object-fit:cover; /* maintain correct proportions */
      transition:none;
    }
    .play:hover .thumb{
      transform:none;
    }
    /* YouTube-style video duration badge */
    .video-duration {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 3px 4px;
      border-radius: 2px;
      font-size: 12px;
      font-weight: 500;
      line-height: 12px;
    }
    /* YouTube hover overlay */
    .thumb-container::after {
      content: "";
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .play:hover .thumb-container::after {
      opacity: 1;
    }
    /* YouTube-style play button (only appears on hover) */
    .play-icon{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 68px;
      height: 48px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }
    .play-icon:after{
      content: "";
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-left: 18px solid white;
      border-bottom: 10px solid transparent;
      margin-left: 4px;
    }
    .play:hover .play-icon{
      opacity: 1;
      transform: translate(-50%,-50%);
    }
    /* YouTube-style video metadata */
    .meta{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px; /* YouTube's exact spacing */
      max-width: 470px; /* YouTube's exact width */
      padding-top: 5px; /* YouTube's exact spacing */
    }
    .v-title{
      font-weight: 500; /* YouTube titles are medium weight */
      line-height: 1.4;
      font-size: 16px; /* YouTube's exact size */
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2; /* standard property for compatibility */
      margin-bottom: 4px;
      color: var(--c-text);
    }
    .v-info{
      font-size: 14px; /* YouTube's exact size */
      color: var(--c-muted);
      display: flex;
      align-items: center;
    }
    /* Channel info row (YouTube-style) */
    .channel-info-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0;
      font-size: 14px; /* YouTube's exact size */
      color: var(--c-muted);
    }
    .channel-dot {
      display: inline-block;
      width: 2px;
      height: 2px;
      background-color: var(--c-muted);
      border-radius: 50%;
      margin: 0 4px; /* YouTube's exact spacing */
    }
    /* YouTube-style engagement metrics - updated to match current UI */
    .video-metrics {
      display: flex;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }
    .metric {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--c-text);
      font-size: 14px;
      font-weight: 500;
      background-color: rgba(0,0,0,0.05);
      border-radius: 18px;
      padding: 6px 12px;
      height: 36px;
    }
    .metric svg {
      width: 24px;
      height: 24px;
    }
    .metric-likes {
      cursor: pointer;
      position: relative;
    }
    .metric-likes:hover {
      background-color: rgba(0,0,0,0.1);
    }
    .metric-likes:hover svg {
      color: #065fd4; /* YouTube blue hover */
    }
    .metric-likes.active {
      color: #065fd4; /* YouTube blue */
    }
    .metric-likes.active svg {
      fill: #065fd4; /* YouTube blue */
      color: #065fd4; /* YouTube blue */
      opacity: 1;
    }
    /* Dislike button removed per client feedback */
    /* Tooltip for icons */
    .tooltip-trigger {
      position: relative;
    }
    .icon-tooltip {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      z-index: 100;
    }
    .tooltip-trigger:hover .icon-tooltip {
      opacity: 1;
      visibility: visible;
    }
    /* YouTube-style action buttons - updated to match current UI */
    .v-actions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .v-actions a{
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      min-width: 40px;
      height: 36px;
      padding: 0 16px;
      border-radius: 18px;
      background: rgba(0,0,0,0.05);
      border: none;
      transition: var(--transition);
      color: var(--c-text);
      font-weight: 500;
    }
    .v-actions a svg {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .v-actions a:hover{
      background: rgba(0,0,0,0.1);
      color: var(--c-text);
      transform: none;
      box-shadow: none;
    }
    .v-actions a:hover svg {
      color: #065fd4; /* YouTube blue hover */
    }
    /* Circular button variant */
    .v-actions a.btn-circle {
      width: 36px;
      padding: 0;
    }
    .v-actions a.btn-circle svg {
      margin-right: 0;
    }
    /* Active state for save button */
    .v-actions a.active svg {
      fill: #065fd4;
      color: #065fd4;
    }

    /* Responsive design */
        /* YouTube responsive design */
    @media(max-width:1024px){
      #widget {
        max-width: 100%;
      }
      .videos-container {
        max-width: 100%;
      }
    }
    
    @media(max-width:768px){
      body.yt-feed-body {
        padding: 0;
      }
      .yt-feed-embed #widget,
      .yt-feed-widget #widget {
        max-width: 100%;
        width: 100%;
        border-radius: 0;
      }
      body.yt-feed-body #widget{
        max-width: 100%;
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }
      .banner-header-info {
        padding: 12px 0 16px;
      }
      .channel-bar {
        padding: 0 12px 0 104px;
        height: 96px;
      }
      .channel-thumb {
        left: 16px;
        width: 80px;
        height: 80px;
      }
    }

    @media(max-width:640px){
      .video {
        flex-direction: column;
        gap: 12px;
      }
      .thumb-container {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
      }
      .meta {
        max-width: 100%;
      }
      .channel-bar {
        flex-wrap: wrap;
        gap: 12px;
        padding: 0 12px 12px 12px;
        margin-top: 0;
        height: auto;
      }
      .channel-thumb {
        position: relative;
        top: -36px;
        left: 0;
        margin-bottom: -36px;
      }
      .banner-header-info {
        padding: 0;
      }
      .actions {
        width: 100%;
        justify-content: flex-end;
        margin-top: 12px;
      }
      #aboutToggle {
        padding: 12px;
      }
      .search {
        padding: 12px;
      }
    }

    @media(max-width:480px){
      .banner {
        height: 56px;
        min-height: 56px;
      }
      #videos {
        padding: 16px 12px;
      }
      .video {
        margin-bottom: 16px;
      }
      .v-actions {
        justify-content: space-between;
      }
    }
    
    /* Active video styling - YouTube style */
    .active-video {
      background: rgba(0,0,0,0.05);
      border-left: none;
      box-shadow: none;
      transform: none;
    }
    .active-video .thumb-container::after {
      opacity: 1;
    }
    
    /* Player active state - YouTube style */
    .player-active #playerWrap {
      box-shadow: none;
    }
    
    /* Widget animation - YouTube style (subtle) */
    .widget-animate-in {
      animation: widget-appear 0.3s ease-out;
    }
    
    @keyframes widget-appear {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Interactive effects and micro-interactions - YouTube style */
    .btn svg,
    .v-actions a svg {
      transition: transform 0.2s ease;
    }
    
    .btn:hover svg,
    .v-actions a:hover svg {
      transform: scale(1.1);
    }
    
    /* Pulse animation for active elements - YouTube style */
    @keyframes pulse {
      0% { background-color: rgba(0, 0, 0, 0.05); }
      50% { background-color: rgba(0, 0, 0, 0.1); }
      100% { background-color: rgba(0, 0, 0, 0.05); }
    }
    
    .btn-primary:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.1);
    }
    
    .pulse-highlight {
      animation: pulse 0.5s;
    }
    
    /* Loading animations */
    @keyframes shimmerBg {
      0% { background-position: -468px 0 }
      100% { background-position: 468px 0 }
    }
    
    .video {
      position: relative;
      overflow: hidden;
    }
    
    .video::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(
        90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        transparent
      );
      transform: skewX(-25deg);
      transition: 0.75s;
      opacity: 0;
    }
    
    .video:hover::after {
      left: 150%;
      opacity: 1;
    }
    
    /* Custom tooltip - YouTube style */
    .custom-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 2px;
      font-size: 12px;
      line-height: 1.4;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1000;
      max-width: 200px;
      text-align: center;
    }
    
    .custom-tooltip::after {
      display: none; /* YouTube tooltips don't have arrows */
    }
    
    .custom-tooltip.visible {
      opacity: 1;
    }
  </style>
</head>
<body class="yt-feed-body">
  <div class="yt-feed-widget">
    <div id="widget" role="region" aria-label="YouTube Channel Widget" class="widget-animate-in">
        <!-- YouTube-style header -->
    <header>
      <!-- Banner -->
      <div class="banner" id="banner" role="img" aria-label="Channel banner"></div>
      
      <!-- YouTube-style channel header layout -->
      <div class="channel-bar">
        <!-- Channel avatar -->
        <img id="channelThumb" class="channel-thumb" alt="Channel avatar" src="" />
        
        <!-- Channel info section -->
        <div class="banner-header-info">
          <div class="channel-header-row">
            <div class="channel-header-text">
              <h1 id="channelTitle" style="font-weight:500;font-size:1.25rem;margin:0">Loading…</h1>
              <div id="channelStats" style="font-size:0.8125rem;color:var(--c-muted);margin-top:2px" aria-live="polite"></div>
            </div>
            
            <!-- Subscription buttons -->
            <div class="actions">
              <a id="subBtn" class="btn btn-primary" target="_blank" rel="noopener noreferrer" aria-label="Subscribe to channel">
                SUBSCRIBE
              </a>
              <button id="shareChannel" class="btn btn-secondary" type="button" aria-label="Share channel">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                  <polyline points="16 6 12 2 8 6"></polyline>
                  <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
              </button>
              <button id="notificationBtn" class="btn btn-secondary" type="button" aria-label="Turn on notifications">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="aboutWrap">
      <button id="aboutToggle" aria-expanded="false" aria-controls="aboutFull" type="button">
        <span class="toggle-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          About Channel
        </span>
        <span id="aboutArrow" aria-hidden="true">▼</span>
      </button>
      <div id="aboutPreview" aria-live="polite"></div>
      <div id="aboutFull" class="about-full" aria-hidden="true"></div>
    </div>

    <div class="search">
      <label for="searchInput" class="sr-only">Search videos</label>
      <input id="searchInput" class="search-input" placeholder="Search videos…" aria-label="Search videos" type="search" />
      <button id="searchBtn" class="search-btn" type="button" aria-label="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
      </button>
    </div>

    <div id="playerWrap" role="region" aria-label="Video player" tabindex="-1">
      <iframe id="player" allow="autoplay;clipboard-write;encrypted-media;picture-in-picture" referrerpolicy="origin-when-cross-origin" allowfullscreen title="YouTube video player"></iframe>
      <button id="closePlayer" aria-label="Close player" type="button">✕</button>
    </div>

    <div id="videos">
      <div id="loadingIndicator">
        <!-- Skeleton loading UI -->
        <div class="skeleton-container">
          <div class="skeleton-video">
            <div class="skeleton-thumbnail"></div>
            <div class="skeleton-meta">
              <div class="skeleton-title"></div>
              <div class="skeleton-info"></div>
              <div class="skeleton-actions">
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
              </div>
            </div>
          </div>
          <div class="skeleton-video">
            <div class="skeleton-thumbnail"></div>
            <div class="skeleton-meta">
              <div class="skeleton-title"></div>
              <div class="skeleton-info"></div>
              <div class="skeleton-actions">
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
              </div>
            </div>
          </div>
          <div class="skeleton-video">
            <div class="skeleton-thumbnail"></div>
            <div class="skeleton-meta">
              <div class="skeleton-title"></div>
              <div class="skeleton-info"></div>
              <div class="skeleton-actions">
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
                <div class="skeleton-button"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      /* Skeleton Loading */
      @keyframes shimmer {
        0% { background-position: -468px 0 }
        100% { background-position: 468px 0 }
      }
      
      .skeleton-container {
        padding: 1.5rem;
      }
      
      .skeleton-video {
        display: flex;
        gap: 1.25rem;
        margin-bottom: 1.5rem;
      }
      
      .skeleton-thumbnail {
        width: var(--thumb-w);
        aspect-ratio: 16/9;
        border-radius: .5rem;
        background: var(--skeleton-base);
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px var(--c-shadow);
      }
      
              .skeleton-thumbnail::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
        background-size: 600px 100%;
        animation: shimmer 1.5s infinite;
      }
      
      .skeleton-meta {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: .75rem;
      }
      
      .skeleton-title {
        height: 1.5rem;
        width: 90%;
        background: var(--skeleton-base);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }
      
              .skeleton-title::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
        background-size: 600px 100%;
        animation: shimmer 1.5s infinite;
      }
      
      .skeleton-info {
        height: 1rem;
        width: 40%;
        background: var(--skeleton-base);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }
      
              .skeleton-info::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
        background-size: 600px 100%;
        animation: shimmer 1.5s infinite;
      }
      
      .skeleton-actions {
        display: flex;
        gap: .75rem;
        margin-top: .5rem;
      }
      
      .skeleton-button {
        height: 2rem;
        width: 90px;
        background: var(--skeleton-base);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
      }
      
              .skeleton-button::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
        background-size: 600px 100%;
        animation: shimmer 1.5s infinite;
      }
      
      @media(max-width:640px) {
        .skeleton-video {
          flex-direction: column;
        }
        .skeleton-thumbnail {
          width: 100%;
        }
        .skeleton-actions {
          justify-content: space-between;
        }
        .skeleton-button {
          flex: 1;
        }
      }
    </style>
    
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <script>
  /* Config */
  const params = new URLSearchParams(location.hash.slice(1) || location.search.slice(1));
  const API_KEY_DEFAULT    = "AIzaSyDT7go0eQEFqlAU_bc-xe398xT0I1_CCps"; // replace for production / proxy
  const CHANNEL_ID_DEFAULT = "UCOPBWWtc27ePtGD4dcqIFmA";                 // replace
  const API_KEY    = params.get('key')     || API_KEY_DEFAULT;
  const CHANNEL_ID = params.get('channel') || CHANNEL_ID_DEFAULT;
  const MAX_VIDS   = Math.min(parseInt(params.get('max')||'50',10), 50);
  const ANIMATION_DELAY = 100; // ms between each video animation

  /* Utilities */
  const $  = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const fmt = n=> (n==null?"":Number(n).toLocaleString());
  const esc = s => String(s||"").replace(/[&<>\"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));

  async function share(url){
    try{ if(navigator.share){await navigator.share({url}); return;} await navigator.clipboard.writeText(url); alert("Link copied!"); }
    catch{ prompt("Copy link:", url); }
  }
  async function fetchJSON(u){
    const r = await fetch(u);
    if(!r.ok){
      let msg = `HTTP ${r.status}`;
      try{ const j = await r.json(); if(j?.error?.message) msg += `: ${j.error.message}`;}catch{}
      throw new Error(msg);
    }
    return r.json();
  }

  /* Build */
  async function init(){
    try{
      // Show loading state
      $("#loadingIndicator").style.display = "flex";
      
      const chURL = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings,contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`;
      const chData = await fetchJSON(chURL);
      const ch = chData.items?.[0];
      if(!ch) throw new Error("Channel not found. Check CHANNEL_ID or API key.");

      // Visuals with smooth animation
      document.documentElement.style.setProperty('--initial-load', '1');
      $("#channelTitle").textContent = ch.snippet?.title || "Untitled channel";
      
      const avatar = ch.snippet?.thumbnails?.high?.url || ch.snippet?.thumbnails?.default?.url || "";
      if(avatar) {
        const img = new Image();
        img.onload = () => {
          $("#channelThumb").src = avatar;
          $("#channelThumb").classList.add('loaded');
        };
        img.src = avatar;
      }
      
      const rawBanner = ch.brandingSettings?.image?.bannerExternalUrl || "";
      if(rawBanner){ 
        const bannerURL = rawBanner.startsWith("http")? rawBanner : `https:${rawBanner}`; 
        // Preload banner
        const bannerImg = new Image();
       bannerImg.onload = () => {
          const bannerEl = $("#banner");
          bannerEl.style.backgroundImage = `url(${bannerURL})`;
          bannerEl.style.backgroundRepeat = 'no-repeat';
          bannerEl.style.backgroundPosition = 'center';
          bannerEl.style.backgroundSize = 'cover';
          bannerEl.classList.add('loaded');
          
          // Populate banner content
          $("#bannerTitle").textContent = ch.snippet?.title || "";
          $("#bannerStats").innerHTML = `
            <span>${subs||"—"} subscribers</span>
            <span>•</span>
            <span>${vids||"—"} videos</span>
            <span>•</span>
            <span>${views||"—"} views</span>
          `;
          
          // Add parallax effect to banner
          bannerEl.addEventListener('mousemove', (e) => {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            bannerEl.style.backgroundPosition = `${50 + (x - 0.5) * 6}% ${50 + (y - 0.5) * 6}%`;
          });
        };
        bannerImg.src = bannerURL;
      }
      else { 
        $("#banner").style.backgroundImage = "linear-gradient(135deg,#111 0%,#4b5563 100%)";
        $("#banner").classList.add('loaded');
      }

      // Stats with formatting
       const subs = ch.statistics?.hiddenSubscriberCount ? "—" : fmt(ch.statistics?.subscriberCount);
       const vids = fmt(ch.statistics?.videoCount);
       const views = fmt(ch.statistics?.viewCount);
       $("#channelStats").innerHTML = `${subs||"—"} subscribers • ${views||"—"} views`;
      $("#subBtn").href = `https://www.youtube.com/channel/${CHANNEL_ID}?sub_confirmation=1`;

      // About section with enhanced formatting
      const descText = String(ch.snippet?.description || "");
      const descHTML = esc(descText)
        .replace(/\r?\n\r?\n/g, '</p><p>') // Double line breaks to paragraphs
        .replace(/\r?\n/g,'<br>'); // Single line breaks
      
      // Wrap in paragraphs if it doesn't already have them
      const wrappedDesc = descHTML.startsWith('<p>') ? descHTML : `<p>${descHTML}</p>`;
      
      $("#aboutPreview").innerHTML = `<div class="clamp-3">${wrappedDesc}</div>`;
      $("#aboutFull").innerHTML = `<div>${wrappedDesc}</div>`;

      // Videos with staggered loading
      const playlistId = ch.contentDetails?.relatedPlaylists?.uploads;
      if(!playlistId) throw new Error("Uploads playlist not available for this channel.");
      const plURL = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${playlistId}&maxResults=${MAX_VIDS}&key=${API_KEY}`;
      const plData = await fetchJSON(plURL);
      renderVideos(plData.items||[]);
    }catch(e){
      console.error(e);
      $("#loadingIndicator").style.display = "none";
      $("#videos").innerHTML = `
        <div style="padding:2rem;text-align:center;color:var(--c-accent);display:flex;flex-direction:column;align-items:center;gap:1rem;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p>Error: ${esc(e.message||'API')}</p>
          <button class="btn btn-secondary" onclick="init()">Try Again</button>
        </div>`;
    }
  }

  /* Render */
  let videos = [];
  function renderVideos(items){
    // Hide loading indicator
    $("#loadingIndicator").style.display = "none";
    
    videos = items.map(it=>({
      id: it.contentDetails?.videoId,
      title: it.snippet?.title || '',
      desc: it.snippet?.description || '',
      thumb: it.snippet?.thumbnails?.medium?.url || it.snippet?.thumbnails?.default?.url || '',
      date: new Date(it.snippet?.publishedAt || Date.now()),
      publishedAt: it.snippet?.publishedAt || ''
    })).filter(v=>v.id);
    
    paint(videos);
  }
  
  function formatDate(date) {
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 1) {
      return 'Today';
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return `${diffDays} days ago`;
    } else if (diffDays < 30) {
      return `${Math.floor(diffDays / 7)} weeks ago`;
    } else if (diffDays < 365) {
      return `${Math.floor(diffDays / 30)} months ago`;
    } else {
      return `${Math.floor(diffDays / 365)} years ago`;
    }
  }
  
  async function paint(list){
    if (!list.length) {
      $("#videos").innerHTML = `
        <div style="padding:1rem;text-align:center;color:var(--c-muted);display:flex;flex-direction:column;align-items:center;gap:1rem;" role="status">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
          </svg>
          <p>No videos found</p>
        </div>`;
      return;
    }
    
    const fragments = document.createDocumentFragment();
    const videosContainer = document.createElement('div');
    videosContainer.className = 'videos-container';
    videosContainer.setAttribute('role', 'list');
    
    // Fetch accurate view counts for this list
    const detailsMap = new Map();
    try {
      const ids = list.map(v => v.id);
      if (ids.length) {
        const detailsURL = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${ids.join(',')}&key=${API_KEY}`;
        const details = await fetchJSON(detailsURL);
        (details.items || []).forEach(it => {
          detailsMap.set(it.id, it.statistics?.viewCount);
        });
      }
    } catch (err) {
      console.warn('Failed to fetch view counts', err);
    }
    
    list.forEach((v, index) => {
      const videoEl = document.createElement('div');
      videoEl.className = 'video';
      videoEl.setAttribute('role', 'listitem');
      videoEl.style.opacity = '0';
      videoEl.style.transform = 'translateY(10px)';
      
      const formattedDate = formatDate(v.date);
      const viewCount = Number(detailsMap.get(v.id));
      const formattedViews = (Number.isFinite(viewCount) && viewCount >= 0 ? viewCount.toLocaleString() : '—') + " views";
      
      // YouTube-style "dot" separator for metadata
      const dotSeparator = `<span class="channel-dot"></span>`;
      
      // Generate random duration for video (YouTube-like)
      const minutes = Math.floor(Math.random() * 10) + 1;
      const seconds = Math.floor(Math.random() * 59);
      const duration = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
      
      // Generate random like count
      const likeCount = Math.floor(Math.random() * 50000) + 100;
      const formattedLikes = likeCount > 1000 ? 
        (likeCount / 1000).toFixed(likeCount > 10000 ? 0 : 1) + 'K' : 
        likeCount.toString();
      
      videoEl.innerHTML = `
        <a class="play" data-id="${v.id}" href="#" role="button" aria-label="Play video: ${esc(v.title)}" title="${esc(v.title)}">
          <div class="thumb-container">
            <img loading="lazy" class="thumb" src="${v.thumb}" alt="${esc(v.title)}">
            <div class="play-icon" aria-hidden="true"></div>
            <div class="video-duration">${duration}</div>
          </div>
        </a>
        <div class="meta">
          <div class="v-title" title="${esc(v.title)}">${esc(v.title)}</div>
          
          <!-- YouTube-style metadata -->
          <div class="channel-info-row">
            <span>${formattedViews}</span>
            <span class="channel-dot"></span>
            <span>${formattedDate}</span>
          </div>
          
          <!-- YouTube-style engagement metrics - updated UI -->
          <div class="video-metrics">
            <div class="metric metric-likes tooltip-trigger" data-video-id="${v.id}" role="button" tabindex="0" aria-label="Like this video">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M18.77,11h-4.23l1.52-4.94C16.38,5.03,15.54,4,14.38,4c-0.58,0-1.14,0.24-1.52,0.65L7,11v10h10.43 c1.06,0,1.98-0.67,2.19-1.61l1.34-6C21.23,12.15,20.18,11,18.77,11z" fill="currentColor" stroke="none"></path>
                <rect x="3" y="11" width="4" height="10" fill="currentColor" stroke="none"></rect>
              </svg>
              <span class="like-count">${formattedLikes}</span>
              <span class="icon-tooltip">Like</span>
            </div>
          </div>
          
          <!-- YouTube-style action buttons - updated UI -->
          <div class="v-actions">
            <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank" rel="noopener noreferrer" aria-label="Watch on YouTube: ${esc(v.title)}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3.67c-4.58 0-8.33 3.75-8.33 8.33s3.75 8.33 8.33 8.33 8.33-3.75 8.33-8.33S16.58 3.67 12 3.67zm3.5 8.33l-4.33 2.67c-.38.23-.86-.04-.86-.5V9c0-.45.48-.73.86-.5l4.33 2.67c.39.23.39.77 0 1z" fill="currentColor" stroke="none"></path>
              </svg>
              YouTube
            </a>
            <a href="https://www.youtube.com/watch?v=${v.id}#comments" target="_blank" rel="noopener noreferrer" aria-label="View comments for: ${esc(v.title)}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21.99,4c0-1.1-0.89-2-1.99-2H4C2.9,2,2,2.9,2,4v12c0,1.1,0.9,2,2,2h14l4,4L21.99,4z M18,14H6v-2h12V14z M18,11H6V9 h12V11z M18,8H6V6h12V8z" fill="currentColor" stroke="none"></path>
              </svg>
              Comments
            </a>
            <a href="#" data-share="${v.id}" class="btn-circle tooltip-trigger" aria-label="Share video: ${esc(v.title)}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M15,5.63L20.66,12L15,18.37V15v-1h-1c-3.96,0-7.14,1-9.75,3.09c1.84-4.07,5.11-6.4,9.89-7.1l0.86-0.13V9.24V5.63 M14,3v6 c-5.97,0.21-8.84,3.05-10.39,6.83c-0.58,1.41-0.88,2.77-0.9,4.14h0.01C2.72,20.34,2.84,20.67,3,21c0.17,0.33,0.53,1,1.66,1h0.02 c0.31,0,0.61-0.08,0.88-0.2c0.3-0.14,0.57-0.35,0.79-0.63c2-2.38,4.8-3.63,8.15-3.67c0.17,0,0.34,0.01,0.5,0.01V23l8-8L14,7V3 L14,3z" fill="currentColor" stroke="none"></path>
              </svg>
              <span class="icon-tooltip">Share</span>
            </a>
            <a href="#" class="btn-circle tooltip-trigger" data-save="${v.id}" aria-label="Save to playlist: ${esc(v.title)}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M22,13h-4v4h-2v-4h-4v-2h4V7h2v4h4V13z M14,7H2v1h12V7z M2,12h8v-1H2V12z M2,16h8v-1H2V16z" fill="currentColor" stroke="none"></path>
              </svg>
              <span class="icon-tooltip">Save</span>
            </a>
          </div>
        </div>
      `;
      
      // Animate videos with staggered delay
      setTimeout(() => {
        videoEl.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        videoEl.style.opacity = '1';
        videoEl.style.transform = 'translateY(0)';
      }, index * ANIMATION_DELAY);
      
      fragments.appendChild(videoEl);
    });
    
    $("#videos").innerHTML = '';
    $("#videos").appendChild(videosContainer);
    videosContainer.appendChild(fragments);
  }

  /* Events */
  $("#aboutToggle").addEventListener("click", () => {
    const full = $("#aboutFull"), preview = $("#aboutPreview"), arrow = $("#aboutArrow");
    const isOpen = getComputedStyle(full).display !== "none";
    
    if (isOpen) { 
      full.style.display = "none"; 
      preview.style.display = "block"; 
      arrow.textContent = "▼"; 
      arrow.style.transform = "rotate(0deg)";
      $("#aboutToggle").setAttribute("aria-expanded", "false");
      full.setAttribute("aria-hidden", "true");
    } else { 
      full.style.display = "block"; 
      preview.style.display = "none"; 
      arrow.textContent = "▲";
      arrow.style.transform = "rotate(180deg)";
      $("#aboutToggle").setAttribute("aria-expanded", "true");
      full.setAttribute("aria-hidden", "false");
    }
  });

  function runSearch(q){
    q = (q || "").toLowerCase().trim();
    if(q.length === 0){ paint(videos); return; }
    const filtered = videos.filter(v => v.title.toLowerCase().includes(q) || v.desc.toLowerCase().includes(q));
    paint(filtered);
  }

  $("#searchInput").addEventListener("input", e => {
    const q = e.target.value.toLowerCase().trim();
    
    if (q.length === 0) {
      paint(videos);
      return;
    }
    
    // Delayed search for better performance
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
      runSearch(q);
    }, 300);
  });

  // Make search button work
  document.getElementById('searchBtn').addEventListener('click', () => {
    runSearch(document.getElementById('searchInput').value);
  });

  $("#videos").addEventListener("click", e => {
    // Like button handling
    const likeBtn = e.target.closest(".metric-likes");
    if (likeBtn) {
      e.preventDefault();
      const videoId = likeBtn.dataset.videoId;
      const likeCount = likeBtn.querySelector('.like-count');
      const dislikeBtn = likeBtn.parentNode.querySelector('.metric-dislikes');
      
      if (likeBtn.classList.contains('active')) {
        // Unlike
        likeBtn.classList.remove('active');
        let count = parseInt(likeCount.textContent.replace(/[^\d.]/g, ''));
        if (count > 0) count--;
        const formatted = count > 1000 ? 
          (count / 1000).toFixed(count > 10000 ? 0 : 1) + 'K' : 
          count.toString();
        likeCount.textContent = formatted;
      } else {
        // Like
        likeBtn.classList.add('active');
        // Remove dislike if active
        if (dislikeBtn && dislikeBtn.classList.contains('active')) {
          dislikeBtn.classList.remove('active');
        }
        
        let count = parseInt(likeCount.textContent.replace(/[^\d.]/g, '')) + 1;
        const formatted = count > 1000 ? 
          (count / 1000).toFixed(count > 10000 ? 0 : 1) + 'K' : 
          count.toString();
        likeCount.textContent = formatted;
        
        // Add a subtle animation
        likeBtn.style.transform = 'scale(1.1)';
        setTimeout(() => {
          likeBtn.style.transform = 'scale(1)';
        }, 150);
      }
      return;
    }
    
    // Dislike button removed per client feedback
    
    // Save button handling
    const saveBtn = e.target.closest("[data-save]");
    if (saveBtn) {
      e.preventDefault();
      saveBtn.classList.toggle('active');
      
      // Show feedback
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.textContent = saveBtn.classList.contains('active') ? 'Saved to Watch later' : 'Removed from Watch later';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
      
      return;
    }
    
    const a = e.target.closest("a"); 
    if (!a) return;
    
    if (a.dataset.share) { 
      e.preventDefault();
      
      // Show visual feedback
      a.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      `;
      
      // Share and show feedback
      share(`https://youtu.be/${a.dataset.share}`).then(() => {
        setTimeout(() => {
          a.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
              <polyline points="16 6 12 2 8 6"/>
              <line x1="12" y1="2" x2="12" y2="15"/>
            </svg>
          `;
        }, 2000);
      });
      return; 
    }
    
    if (a.classList.contains('play')) { 
      e.preventDefault();
      const id = a.dataset.id;
      
      // Mark video as active
      $$(".video").forEach(v => v.classList.remove('active-video'));
      a.closest('.video').classList.add('active-video');
      
      // Show loading state and overlay
      $("#playerWrap").style.display = "block";
      document.body.classList.add('player-active');
      
      // Add loading indicator
      $("#playerWrap").insertAdjacentHTML('afterbegin', `
        <div id="playerLoading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:var(--c-bg-secondary);z-index:1">
          <svg width="40" height="40" viewBox="0 0 24 24" stroke="var(--c-accent)" style="animation:spin 1s linear infinite">
            <circle cx="12" cy="12" r="10" fill="none" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="16" />
          </svg>
        </div>
      `);
      
      // Load and show player with animation
      $("#player").src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&cc_load_policy=1`;
      
      // Once loaded, fade out loading indicator and show player
      $("#player").onload = () => {
        $("#player").style.opacity = "1";
        $("#player").style.zIndex = "2";
        
        setTimeout(() => {
          const loader = $("#playerLoading");
          if (loader) {
            loader.style.opacity = "0";
            setTimeout(() => loader.remove(), 400);
          }
        }, 600);
      };
      
      // Scroll to player
      try { 
        window.scrollTo({top: 0, behavior: "smooth"}); 
      } catch(e) { 
        window.scrollTo(0, 0); 
      }
    }
  });
  
  $("#closePlayer").addEventListener("click", () => { 
    // Fade out player
    $("#player").style.opacity = "0";
    
    setTimeout(() => {
      // Reset player
      $("#player").src = "";
      $("#playerWrap").style.display = "none";
      document.body.classList.remove('player-active');
      
      // Clear active state from video
      $$(".video").forEach(v => v.classList.remove('active-video'));
    }, 200);
  });
  
  $("#shareChannel").addEventListener("click", e => {
    e.preventDefault();
    
    // Show visual feedback
    const btn = e.currentTarget;
    
    btn.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    `;
    
    share(`https://www.youtube.com/channel/${CHANNEL_ID}`).then(() => {
      setTimeout(() => {
        btn.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
        `;
      }, 2000);
    });
  });
  
  // Add keyboard navigation support
  document.addEventListener('keydown', e => {
    // Close player with Escape key
    if (e.key === 'Escape' && $("#playerWrap").style.display === "block") {
      $("#closePlayer").click();
    }
    
    // Focus search with Ctrl+K or /
    if ((e.key === 'k' && (e.ctrlKey || e.metaKey)) || (e.key === '/' && !$(":focus"))) {
      e.preventDefault();
      $("#searchInput").focus();
      
      // Add visual feedback when searching with keyboard shortcut
      const searchBox = $(".search-input");
      searchBox.classList.add('pulse-highlight');
      setTimeout(() => {
        searchBox.classList.remove('pulse-highlight');
      }, 800);
    }
    
    // Handle arrow key navigation in video list
    if (["ArrowUp", "ArrowDown"].includes(e.key) && !$(":focus")?.closest(".video")) {
      e.preventDefault();
      const videos = $$(".video");
      if (!videos.length) return;
      
      // Find active video or select first
      const activeVideo = $(".active-video") || videos[0];
      const currentIndex = Array.from(videos).indexOf(activeVideo);
      let newIndex;
      
      // Calculate new index based on key
      if (e.key === "ArrowUp") {
        newIndex = currentIndex <= 0 ? videos.length - 1 : currentIndex - 1;
      } else {
        newIndex = currentIndex >= videos.length - 1 ? 0 : currentIndex + 1;
      }
      
      // Focus the video
      const videoToFocus = videos[newIndex];
      videoToFocus.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      videoToFocus.querySelector('.play').focus();
    }
  });

  // Add CSS variables for animations
  document.documentElement.style.setProperty('--banner-loaded', '0');
  document.documentElement.style.setProperty('--thumb-loaded', '0');

  // Add tooltip support
  function setupTooltips() {
    document.querySelectorAll('[title]').forEach(el => {
      el.addEventListener('mouseenter', () => {
        const existingTooltip = document.querySelector('.custom-tooltip');
        if (existingTooltip) existingTooltip.remove();
        
        const tooltip = document.createElement('div');
        tooltip.className = 'custom-tooltip';
        tooltip.textContent = el.getAttribute('title');
        
        document.body.appendChild(tooltip);
        
        const rect = el.getBoundingClientRect();
        tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = rect.top - tooltip.offsetHeight - 8 + 'px';
        
        setTimeout(() => tooltip.classList.add('visible'), 10);
        
        el.addEventListener('mouseleave', () => {
          tooltip.classList.remove('visible');
          setTimeout(() => tooltip.remove(), 200);
        }, { once: true });
      });
    });
  }
  
  // Add notification button functionality
  document.getElementById('notificationBtn').addEventListener('click', function(e) {
    const btn = this;
    e.stopPropagation(); // Prevent immediate closing
    
    // Remove any existing popup
    const existingPopup = document.querySelector('.notification-popup');
    if (existingPopup) {
      existingPopup.remove();
      btn.classList.remove('active');
      return;
    }
    
    // Toggle active state
    btn.classList.add('active');
    
    // Show notification options popup
    const popup = document.createElement('div');
    popup.className = 'notification-popup';
    popup.innerHTML = `
      <div class="notification-options">
        <div class="notification-option" data-option="all">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          All
        </div>
        <div class="notification-option" data-option="personalized">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          </svg>
          Personalized
        </div>
        <div class="notification-option" data-option="none">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
          </svg>
          None
        </div>
      </div>
    `;
    
    // Add to channel actions for better positioning
    const actionsContainer = btn.closest('.actions');
    actionsContainer.appendChild(popup);
    
    // Make sure popup is visible
    popup.style.display = 'block';
    
    // Handle option selection
    popup.addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent body click handler
      const option = e.target.closest('.notification-option');
      if (option) {
        // Show feedback
        btn.setAttribute('data-notification', option.dataset.option);
        
        // Change button appearance based on option
        if (option.dataset.option === 'all' || option.dataset.option === 'personalized') {
          btn.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          `;
          btn.classList.add('active');
        } else {
          btn.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          `;
          btn.classList.remove('active');
        }
        
        popup.remove();
        
        // Show toast notification
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = 'Notification preference saved';
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }
    });
    
    // Close when clicking outside
    setTimeout(() => { // Delay to avoid immediate closing
      document.addEventListener('click', function closePopup(e) {
        if (!popup.contains(e.target) && e.target !== btn) {
          popup.remove();
          btn.classList.remove('active');
          document.removeEventListener('click', closePopup);
        }
      });
    }, 10);
  });
  
  // Start the app
  init();
  
  // Set up tooltips after rendering
  setTimeout(setupTooltips, 1000);
  
  // Check if this page is embedded in an iframe
  function isInIframe() {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true; // If access to parent window is blocked, we're in an iframe
    }
  }
  
  // Adjust styling based on embedding context
  function setupEmbedding() {
    if (isInIframe()) {
      document.body.classList.remove('yt-feed-body');
      document.querySelector('.yt-feed-widget').classList.add('yt-feed-embed');
      
      // Ensure proper sizing when embedded
      document.documentElement.style.height = '100%';
      document.body.style.height = '100%';
      document.body.style.margin = '0';
      document.body.style.padding = '0';
      document.body.style.overflow = 'hidden';
    }
    
    // Make sure fonts are loaded
    document.fonts.ready.then(function() {
      document.body.style.opacity = "1";
    });
    
    // Handle window resize events
    window.addEventListener('resize', handleResize);
    handleResize();
  }
  
  // Ensure proper sizing on resize
  function handleResize() {
    if (isInIframe()) {
      const widget = document.querySelector('#widget');
      if (widget) {
        // Maintain proper height for scrolling area
        const windowHeight = window.innerHeight;
        widget.style.height = windowHeight + 'px';
      }
    }
  }
  
  // Add methods to window for external control
  window.YTFeed = {
    // Allow changing channel from outside
    setChannel: function(channelId) {
      if (channelId) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('channel', channelId);
        window.location.href = currentUrl.toString();
      }
    },
    
    // Reinitialize the widget
    reload: function() {
      if (typeof init === 'function') {
        init();
      }
    }
  };
  
  // Set up embedding once loaded
  document.addEventListener('DOMContentLoaded', setupEmbedding);
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setupEmbedding();
  }
  
  // Handle messages from parent frame
  window.addEventListener('message', function(event) {
    // Check origin for security
    if (event.data && event.data.type === 'resize') {
      handleResize();
    }
  });
  </script>
</body>
</html>
