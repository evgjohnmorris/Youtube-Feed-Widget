<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Channel Widget for Notion</title>

    <!-- ============================================================
         CSS – light & dark with CSS vars (auto‑detect)              
    ============================================================ -->
    <style>
      :root {
        --bg: #ffffff;
        --text: #1e1e1e;
        --muted: #4b5563;
        --border: #e5e7eb;
        --card: #ffffff;
      }
      body.dark {
        --bg: #18181b;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --border: #27272a;
        --card: #1f2937;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      a { color: inherit; text-decoration: none; }

      /* ------------------- CONTAINER ------------------- */
      #widget {
        max-width: 740px;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        background: var(--card);
      }

      /* ------------------- HEADER ------------------- */
      .banner {
        height: 160px;
        background-size: cover;
        background-position: center;
        position: relative;
      }
      .banner::after {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
      }
      .channel-bar {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: var(--card);
        border-bottom: 1px solid var(--border);
      }
      .channel-thumb {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--card);
        flex-shrink: 0;
      }
      .channel-meta { flex: 1; min-width: 0; }
      .channel-title {
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.3;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      }
      .channel-stats { font-size: 0.875rem; color: var(--muted); }
      /* collapsible description */
      details#channelDesc {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--muted);
      }
      details#channelDesc > summary {
        cursor: pointer;
        list-style: none;
        display: inline-block;
        padding: 2px 0;
      }
      details#channelDesc[open] > summary::after { content: " ▲"; }
      details#channelDesc:not([open]) > summary::after { content: " ▼"; }

      /* ------------------- PLAYER ------------------- */
      .player-wrap {
        display: none; /* revealed when a video is chosen */
        position: relative;
        background: #000;
        aspect-ratio: 16 / 9;
      }
      .player-wrap.active { display: block; }
      .player-wrap iframe { width: 100%; height: 100%; border: 0; }
      .close-btn {
        position: absolute;
        top: 6px;
        right: 8px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border: 0;
        border-radius: 9999px;
        width: 28px; height: 28px;
        font-size: 1rem;
        cursor: pointer;
      }

      /* ------------------- SEARCH ------------------- */
      .search-wrap {
        display: flex; justify-content: flex-end;
        padding: 0.75rem 1rem 0.5rem;
      }
      .search-input {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        background: var(--bg);
        color: var(--text);
      }

      /* ------------------- VIDEO LIST ------------------- */
      .videos { padding: 1rem; }
      .video-item {
        display: flex; gap: 0.75rem; margin-bottom: 1rem;
        cursor: pointer;
      }
      .video-thumb {
        width: 180px; aspect-ratio: 16 / 9;
        object-fit: cover; border-radius: 0.25rem;
        flex-shrink: 0;
      }
      .video-title { font-weight: 600; margin-bottom: 0.25rem; line-height: 1.4; }
      .video-stats { font-size: 0.75rem; color: var(--muted); margin-bottom: 2px; }
      .video-desc { font-size: 0.875rem; color: var(--muted); line-height: 1.3; }

      /* ------------------- DARK MODE SPECIFICS ------------------- */
      body.dark .banner::after { background: rgba(0,0,0,0.45); }
    </style>
  </head>
  <body>
    <div id="widget">
      <!-- Banner image filled by JS -->
      <div class="banner" id="banner"></div>

      <!-- Channel bar -->
      <div class="channel-bar">
        <img class="channel-thumb" id="channelThumb" alt="thumb" />
        <div class="channel-meta">
          <div class="channel-title" id="channelTitle"></div>
          <div class="channel-stats" id="channelStats"></div>
          <details id="channelDesc"><summary>About</summary><p id="channelDescText"></p></details>
        </div>
      </div>

      <!-- Inline player (hidden until used) -->
      <div class="player-wrap" id="playerWrap">
        <button class="close-btn" id="closePlayer">×</button>
        <iframe id="playerFrame" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
      </div>

      <!-- Search -->
      <div class="search-wrap">
        <input type="search" class="search-input" id="searchInput" placeholder="Search videos…" />
      </div>

      <!-- Videos list -->
      <div class="videos" id="videos"></div>
    </div>

    <!-- ============================================================
         JS – fetch data, render, interactions                      
    ============================================================ -->
    <script type="module">
      /* ---------------- CONFIG ---------------- */
      const API_KEY     = "AIzaSyDT7go0eQEFqlAU_bc-xe398xT0I1_CCps";   // ← replace & restrict
      const CHANNEL_ID  = "UCOPBWWtc27ePtGD4dcqIFmA"; // ← replace
      const MAX_RESULTS = 25;

      /* ------------- UTILITIES -------------- */
      const $ = (sel) => document.querySelector(sel);
      const fmtNumber = (n) => Number(n).toLocaleString();
      const fmtDate = (iso) => new Date(iso).toLocaleDateString(undefined, {year:"numeric", month:"short", day:"numeric"});
      const json = async (url) => {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      };

      /* ------------- DARK‑MODE AUTO --------- */
      if (matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark');

      /* ------------- MAIN ------------------- */
      let allVideos = [];

      async function init() {
        try {
          /* Get channel details */
          const ch = (await json(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings,contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`)).items[0];
          renderHeader(ch);

          /* Fetch uploads playlist */
          const uploadsPl = ch.contentDetails.relatedPlaylists.uploads;
          const items = (await json(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${uploadsPl}&maxResults=${MAX_RESULTS}&key=${API_KEY}`)).items;

          /* Extra call to get per‑video statistics */
          const ids = items.map(it => it.contentDetails.videoId).join(',');
          const statsResp = await json(`https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${ids}&key=${API_KEY}`);
          const statsMap = Object.fromEntries(statsResp.items.map(v => [v.id, v]));

          allVideos = items.map(it => {
            const vid = statsMap[it.contentDetails.videoId];
            return {
              id: it.contentDetails.videoId,
              title: it.snippet.title,
              desc: it.snippet.description,
              thumb: it.snippet.thumbnails.medium.url,
              views: vid ? vid.statistics.viewCount : "0",
              date: vid ? vid.snippet.publishedAt : it.contentDetails.videoPublishedAt
            };
          });

          paint(allVideos);
        } catch(err) {
          console.error(err);
          $("#videos").innerHTML = `<p style="color:#ef4444;padding:1rem">${err.message}</p>`;
        }
      }

      /* ------ render header ------ */
      function renderHeader(ch) {
        $("#channelTitle").textContent = ch.snippet.title;
        $("#channelThumb").src = ch.snippet.thumbnails.high.url;
        $("#channelStats").textContent = `${fmtNumber(ch.statistics.subscriberCount)} subscribers • ${fmtNumber(ch.statistics.videoCount)} videos • ${fmtNumber(ch.statistics.viewCount)} views`;
        $("#channelDescText").textContent = ch.snippet.description || "";
        if (ch.brandingSettings?.image?.bannerExternalUrl)
          $("#banner").style.backgroundImage = `url(${ch.brandingSettings.image.bannerExternalUrl})`;
      }

      /* ------ paint video list ------ */
      function paint(list) {
        const wrap = $("#videos");
        wrap.innerHTML = "";
        list.forEach(v => {
          const div = document.createElement("div");
          div.className = "video-item";
          div.innerHTML = `
            <img loading="lazy" src="${v.thumb}" class="video-thumb" alt="${v.title}" />
            <div class="video-meta">
              <div class="video-title">${v.title}</div>
              <div class="video-stats">${fmtNumber(v.views)} views • ${fmtDate(v.date)}</div>
              <div class="video-desc">${(v.desc || "").slice(0, 140)}…</div>
            </div>`;
          div.addEventListener('click', () => openPlayer(v.id));
          wrap.appendChild(div);
        });
      }

      /* ------ inline player controls ------ */
      function openPlayer(id) {
        const frame = $("#playerFrame");
        frame.src = `https://www.youtube.com/embed/${id}?autoplay=1`;
        $("#playerWrap").classList.add('active');
        $("#playerWrap").scrollIntoView({behavior:'smooth'});
      }
      $("#closePlayer").addEventListener('click', () => {
        $("#playerWrap").classList.remove('active');
        $("#playerFrame").src = "";
      });

      /* ------ search ------ */
      $("#searchInput").addEventListener('input', e => {
        const q = e.target.value.toLowerCase();
        paint(allVideos.filter(v => v.title.toLowerCase().includes(q) || v.desc.toLowerCase().includes(q)));
      });

      init();
    </script>
  </body>
</html>
