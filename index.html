<!--
===========================================================================
  YouTube Channel Widget for Notion ─ v3.3 (stable)
  -------------------------------------------------------------------------
  • Banner + channel bar with Subscribe / Share
  • 3‑line “About” preview with expandable toggle (robust in Notion)
  • Inline player + close button
  • Video list with Open / Comments / Share
  • Search, dark‑mode, lazy‑load thumbnails, fluid layout
  • NO external libraries (just fetch)
  • API key & channel overridable via URL hash/query
  • Defensive against missing fields / hidden subs
===========================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Widget</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --c-text:#1e1e1e; --c-muted:#6b7280; --c-line:#e5e7eb; --c-bg:#ffffff;
      --c-accent:#ef4444; --c-shadow:rgba(0,0,0,.06); --radius:.5rem; --thumb-w:180px;
    }
    @media (prefers-color-scheme:dark){
      :root{ --c-text:#e5e7eb; --c-muted:#9ca3af; --c-line:#374151; --c-bg:#1f2937; --c-shadow:rgba(0,0,0,.4) }
    }
    body{font-family:Inter,system-ui,sans-serif;background:var(--c-bg);color:var(--c-text)}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer;background:none;border:0;color:inherit}

    /* Shell */
    #widget{display:flex;flex-direction:column;max-width:720px;height:100%;border:1px solid var(--c-line);border-radius:var(--radius);overflow:hidden;box-shadow:0 4px 8px var(--c-shadow)}

    /* Banner */
    .banner{height:22vh;min-height:120px;background-size:cover;background-position:center;position:relative}
    .banner::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.35)}

    /* Channel bar */
    .channel-bar{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--c-bg);border-bottom:1px solid var(--c-line)}
    .channel-thumb{width:72px;height:72px;border-radius:50%;object-fit:cover;border:2px solid var(--c-bg);background:#111}
    .actions{margin-left:auto;display:flex;gap:.5rem}
    .btn{font-size:.875rem;padding:.35rem .8rem;border:1px solid var(--c-line);border-radius:.375rem;display:inline-flex;align-items:center;gap:.35rem}
    .btn:hover{background:var(--c-line)}

    /* About */
    #aboutWrap{border-bottom:1px solid var(--c-line);background:var(--c-bg)}
    #aboutToggle{display:flex;align-items:center;gap:.35rem;font-size:.875rem;padding:.75rem 1rem}
    #aboutPreview{padding:0 1rem 1rem;font-size:.875rem}
    .about-full{padding:0 1rem 1rem;font-size:.875rem}
    .about-full p{margin-bottom:.75rem;line-height:1.4}
    /* Robust: control via inline display, not [hidden] */
    .about-full{display:none}

    /* Search */
    .search{padding:1rem;border-bottom:1px solid var(--c-line);background:var(--c-bg)}
    .search-input{width:100%;padding:.45rem .75rem;border:1px solid var(--c-line);border-radius:.375rem;font-size:.875rem;background:transparent;color:inherit}

    /* Player */
    #playerWrap{position:relative;padding-top:56.25%;display:none}
    #player{position:absolute;inset:0;width:100%;height:100%;border:0}
    #closePlayer{position:absolute;top:.5rem;right:.5rem;background:rgba(0,0,0,.5);color:#fff;border-radius:9999px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}

    /* Videos */
    #videos{flex:1;overflow:auto;padding:1rem;background:var(--c-bg)}
    .video{display:flex;gap:.75rem;margin-bottom:1rem}
    .thumb{width:var(--thumb-w);aspect-ratio:16/9;object-fit:cover;border-radius:.25rem}
    .meta{flex:1;display:flex;flex-direction:column;gap:.4rem}
    .v-title{font-weight:600;line-height:1.4}
    .v-info{font-size:.75rem;color:var(--c-muted)}
    .v-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .v-actions a{font-size:.75rem;border:1px solid transparent;padding:.2rem .4rem;border-radius:.25rem}
    .v-actions a:hover{border-color:var(--c-line)}

    @media(max-width:479px){.video{flex-direction:column}.thumb{width:100%}.v-actions{margin-top:.25rem}}
  </style>
</head>
<body>
  <div id="widget">
    <div class="banner" id="banner"></div>
    <div class="channel-bar">
      <img id="channelThumb" class="channel-thumb" alt="Channel avatar" src="" />
      <div>
        <div id="channelTitle" style="font-weight:600">Loading…</div>
        <div id="channelStats" style="font-size:.875rem;color:var(--c-muted)"></div>
      </div>
      <div class="actions">
        <a id="subBtn" class="btn" target="_blank" rel="noopener noreferrer">🔔 Subscribe</a>
        <button id="shareChannel" class="btn" type="button">↗ Share</button>
      </div>
    </div>

    <div id="aboutWrap">
      <button id="aboutToggle" aria-expanded="false" aria-controls="aboutFull" type="button">About <span id="aboutArrow">▼</span></button>
      <div id="aboutPreview"></div>
      <div id="aboutFull" class="about-full"></div>
    </div>

    <div class="search">
      <input id="searchInput" class="search-input" placeholder="Search videos…" aria-label="Search videos" />
    </div>

    <div id="playerWrap">
      <iframe id="player" allow="autoplay;clipboard-write;encrypted-media;picture-in-picture" referrerpolicy="origin-when-cross-origin" allowfullscreen></iframe>
      <button id="closePlayer" aria-label="Close player" type="button">✕</button>
    </div>

    <div id="videos"></div>
  </div>

  <script>
  /* Config */
  const params = new URLSearchParams(location.hash.slice(1) || location.search.slice(1));
  const API_KEY_DEFAULT    = "AIzaSyDT7go0eQEFqlAU_bc-xe398xT0I1_CCps"; // replace for production / proxy
  const CHANNEL_ID_DEFAULT = "UCOPBWWtc27ePtGD4dcqIFmA";                 // replace
  const API_KEY    = params.get('key')     || API_KEY_DEFAULT;
  const CHANNEL_ID = params.get('channel') || CHANNEL_ID_DEFAULT;
  const MAX_VIDS   = Math.min(parseInt(params.get('max')||'50',10), 50);

  /* Utilities */
  const $  = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const fmt = n=> (n==null?"":Number(n).toLocaleString());
  const esc = s => String(s||"").replace(/[&<>\"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
  const paragraphs = txt => String(txt||"").split(/
?
+/).filter(p=>p.trim());

  async function share(url){
    try{ if(navigator.share){await navigator.share({url}); return;} await navigator.clipboard.writeText(url); alert("Link copied!"); }
    catch{ prompt("Copy link:", url); }
  }
  async function fetchJSON(u){
    const r = await fetch(u);
    if(!r.ok){
      let msg = `HTTP ${r.status}`;
      try{ const j = await r.json(); if(j?.error?.message) msg += `: ${j.error.message}`;}catch{}
      throw new Error(msg);
    }
    return r.json();
  }

  /* Build */
  async function init(){
    try{
      const chURL = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings,contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`;
      const chData = await fetchJSON(chURL);
      const ch = chData.items?.[0];
      if(!ch) throw new Error("Channel not found. Check CHANNEL_ID or API key.");

      // Visuals
      $("#channelTitle").textContent = ch.snippet?.title || "Untitled channel";
      const avatar = ch.snippet?.thumbnails?.high?.url || ch.snippet?.thumbnails?.default?.url || "";
      if(avatar) $("#channelThumb").src = avatar;
      const rawBanner = ch.brandingSettings?.image?.bannerExternalUrl || "";
      if(rawBanner){ const bannerURL = rawBanner.startsWith("http")? rawBanner : `https:${rawBanner}`; $("#banner").style.backgroundImage = `url(${bannerURL})`; }
      else { $("#banner").style.backgroundImage = "linear-gradient(135deg,#111 0%,#4b5563 100%)"; }

      // Stats
      const subs = ch.statistics?.hiddenSubscriberCount ? "—" : fmt(ch.statistics?.subscriberCount);
      const vids = fmt(ch.statistics?.videoCount);
      const views = fmt(ch.statistics?.viewCount);
      $("#channelStats").textContent = `${subs||"—"} subs • ${vids||"—"} videos • ${views||"—"} views`;
      $("#subBtn").href = `https://www.youtube.com/channel/${CHANNEL_ID}?sub_confirmation=1`;

      // About
      const paras = paragraphs(ch.snippet?.description);
      $("#aboutPreview").innerHTML = esc(paras.slice(0,3).join('

')).replace(/

/g,'<br><br>');
      $("#aboutFull").innerHTML    = paras.map(p=>`<p>${esc(p)}</p>`).join('');

      // Videos
      const playlistId = ch.contentDetails?.relatedPlaylists?.uploads;
      if(!playlistId) throw new Error("Uploads playlist not available for this channel.");
      const plURL = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${playlistId}&maxResults=${MAX_VIDS}&key=${API_KEY}`;
      const plData = await fetchJSON(plURL);
      renderVideos(plData.items||[]);
    }catch(e){
      console.error(e);
      $("#videos").innerHTML = `<p style="color:var(--c-accent)">Error: ${esc(e.message||'API')}</p>`;
    }
  }

  /* Render */
  let videos = [];
  function renderVideos(items){
    videos = items.map(it=>({
      id:it.contentDetails?.videoId,
      title:it.snippet?.title||'',
      desc:it.snippet?.description||'',
      thumb:it.snippet?.thumbnails?.medium?.url || it.snippet?.thumbnails?.default?.url || '',
      date:new Date(it.snippet?.publishedAt||Date.now()).toLocaleDateString()
    })).filter(v=>v.id);
    paint(videos);
  }
  function paint(list){
    const out = list.map(v=>`
      <div class="video">
        <a class="play" data-id="${v.id}">
          <img loading="lazy" class="thumb" src="${v.thumb}" alt="${esc(v.title)}">
        </a>
        <div class="meta">
          <div class="v-title">${esc(v.title)}</div>
          <div class="v-info">${v.date}</div>
          <div class="v-actions">
            <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank" rel="noopener noreferrer">▶ Open on YouTube</a>
            <a href="https://www.youtube.com/watch?v=${v.id}#comments" target="_blank" rel="noopener noreferrer">💬 Comments</a>
            <a href="#" data-share="${v.id}">↗ Share</a>
          </div>
        </div>
      </div>`).join('');
    $("#videos").innerHTML = out || '<p style="color:var(--c-muted)">No videos found.</p>';
  }

  /* Events */
  $("#aboutToggle").addEventListener("click", () => {
    const full = $("#aboutFull"), preview = $("#aboutPreview"), arrow = $("#aboutArrow");
    const isOpen = getComputedStyle(full).display !== "none";
    if (isOpen) { full.style.display = "none"; preview.style.display = "block"; arrow.textContent = "▼"; $("#aboutToggle").setAttribute("aria-expanded","false"); }
    else { full.style.display = "block"; preview.style.display = "none"; arrow.textContent = "▲"; $("#aboutToggle").setAttribute("aria-expanded","true"); }
  });

  $("#searchInput").addEventListener("input",e=>{
    const q = e.target.value.toLowerCase();
    paint(videos.filter(v=> v.title.toLowerCase().includes(q) || v.desc.toLowerCase().includes(q)));
  });

  $("#videos").addEventListener("click",e=>{
    const a = e.target.closest("a"); if(!a) return;
    if(a.dataset.share){ e.preventDefault(); share(`https://youtu.be/${a.dataset.share}`); return; }
    if(a.classList.contains('play')){ const id=a.dataset.id; $("#player").src = `https://www.youtube.com/embed/${id}?autoplay=1`; $("#playerWrap").style.display = "block"; try{ window.scrollTo({top:0,behavior:"smooth"}); }catch{} e.preventDefault(); }
  });
  $("#closePlayer").addEventListener("click",()=>{ $("#player").src=""; $("#playerWrap").style.display="none"; });
  $("#shareChannel").addEventListener("click",()=>share(`https://www.youtube.com/channel/${CHANNEL_ID}`));

  init();
  </script>
</body>
</html>
